{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8c36898c-e7e7-4a72-92d0-55e501ae5de6",
   "metadata": {},
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "import matplotlib.pyplot as plt\n",
    "plt.style.use('fivethirtyeight')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "372d7e66-e35f-49eb-ae0f-c5199939ece6",
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "from datascience import *"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6ca9c546-db4d-4170-85ff-256bbac7eb89",
   "metadata": {},
   "outputs": [],
   "source": [
    "#importing table\n",
    "#making new table for each risk level classification\n",
    "\n",
    "health_table = Table().read_table('Health_Risk_Dataset.csv')\n",
    "high = health_table.where('Risk_Level', are.equal_to('High'))\n",
    "medium = health_table.where('Risk_Level', are.equal_to('Medium'))\n",
    "normal = health_table.where('Risk_Level', are.equal_to('Normal'))\n",
    "health_table.show(10)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "302d9a37-0d9a-496e-a376-d4c691a0ec43",
   "metadata": {},
   "outputs": [],
   "source": [
    "#using scikit to find the weights of each category and it's affect on the original classification\n",
    "#using a random forest classifer\n",
    "\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.ensemble import RandomForestClassifier\n",
    "\n",
    "health_pd = pd.read_csv('Health_Risk_Dataset.csv')\n",
    "\n",
    "#features\n",
    "feature_cols = ['Respiratory_Rate', 'Oxygen_Saturation', 'O2_Scale', \n",
    "                'Systolic_BP', 'Heart_Rate', 'Temperature', \n",
    "                'Consciousness', 'On_Oxygen']\n",
    "\n",
    "X = health_pd[feature_cols]\n",
    "\n",
    "categorical_cols = ['Consciousness', 'On_Oxygen', 'O2_Scale']\n",
    "X = pd.get_dummies(X, columns=categorical_cols)\n",
    "\n",
    "#target\n",
    "y = health_pd['Risk_Level']\n",
    "\n",
    "#Split data\n",
    "train_X, val_X, train_y, val_y = train_test_split(X, y, test_size=0.2, random_state=0)\n",
    "\n",
    "rf_model = RandomForestClassifier(random_state=0, n_estimators=100)\n",
    "rf_model.fit(train_X, train_y)\n",
    "\n",
    "#feature importance values\n",
    "importances = rf_model.feature_importances_\n",
    "\n",
    "feature_names = X.columns\n",
    "for name, importance in zip(feature_names, importances):\n",
    "    print(f\"{name}: {importance:.3f}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d91e61ce-60c9-4b90-80ef-85b6049f6c3b",
   "metadata": {},
   "outputs": [],
   "source": [
    "#making the weights, multiplying the array by 100 because we are on an 100 points system\n",
    "\n",
    "weights = (importances * 100)\n",
    "resp_weight = weights.item(0)\n",
    "oxy_weight = weights.item(1)\n",
    "o2scale_weight = weights.item(2)\n",
    "bp_weight = weights.item(3)\n",
    "hr_weight = weights.item(4)\n",
    "temp_weight = weights.item(5)\n",
    "conc_weight  = weights.item(6) + weights.item(7) + weights.item(8) + weights.item(9) + weights.item(10)\n",
    "onoxy_weight = weights.item(11) + weights.item(12)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a3c0d931-9f0e-4234-a973-273f67437327",
   "metadata": {},
   "outputs": [],
   "source": [
    "#reprinting of the normal threshold\n",
    "\n",
    "print('normal heart rate is less than' + ' ' + str(np.mean(normal.column('Heart_Rate'))))\n",
    "print('normal respiratory rate is less than' + ' ' + str(np.mean(normal.column('Respiratory_Rate'))))\n",
    "print('normal oxygen saturation is more than' + ' ' + str(np.mean(normal.column('Oxygen_Saturation'))))\n",
    "print('normal systolic BP is more than' + ' ' + str(np.mean(normal.column('Systolic_BP'))))\n",
    "print('normal temperature is less than' + ' ' + str(np.mean(normal.column('Temperature'))))\n",
    "\n",
    "normal_hr = np.mean(normal.column('Heart_Rate'))\n",
    "normal_resp_rate = np.mean(normal.column('Respiratory_Rate'))\n",
    "normal_oxysat = np.mean(normal.column('Oxygen_Saturation'))\n",
    "normal_systbp = np.mean(normal.column('Systolic_BP'))\n",
    "normal_temp = np.mean(normal.column('Temperature'))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c3137173-53e4-48a5-b9a4-b19ba925613c",
   "metadata": {},
   "outputs": [],
   "source": [
    "#functions to find percentile\n",
    "#the more function for when the value being more is abnormal, the less function for when the value being less is abnormal\n",
    "\n",
    "def percentile_more(measurement, table, column):\n",
    "    return np.sum(measurement >= table.column(column)) / len(table.column(column))\n",
    "\n",
    "def percentile_less(measurement, table, column):\n",
    "    return np.sum(measurement <= table.column(column)) / len(table.column(column))\n",
    "\n",
    "#test\n",
    "percentile_more(22, health_table, 'Respiratory_Rate')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b8df21f0-5df5-4575-8170-39831eab84b3",
   "metadata": {},
   "outputs": [],
   "source": [
    "#big meaty function\n",
    "#multiplying the percentile by the weight and adding it to points if they are above/below the threshold\n",
    "#for categorical variables adding the points according to importance or if the condition is met\n",
    "\n",
    "def points(Patient_ID):\n",
    "    patient = example_patients.where('Patient_ID', are.equal_to(Patient_ID))\n",
    "    points = 0\n",
    "    if patient.column('Respiratory_Rate') > normal_resp_rate:\n",
    "        points = percentile_more(patient.column('Respiratory_Rate').item(0), health_table, 'Respiratory_Rate') * resp_weight\n",
    "    if patient.column('Heart_Rate') > normal_hr:\n",
    "        points = points + percentile_more(patient.column('Heart_Rate').item(0), health_table, 'Heart_Rate') * hr_weight\n",
    "    if patient.column('Oxygen_Saturation') < normal_oxysat:\n",
    "        points = points + percentile_less(patient.column('Oxygen_Saturation').item(0), health_table, 'Oxygen_Saturation') * oxy_weight\n",
    "    if patient.column('Systolic_BP') < normal_systbp:\n",
    "        points = points + percentile_less(patient.column('Systolic_BP').item(0), health_table, 'Systolic_BP') * bp_weight\n",
    "    if patient.column('Systolic_BP') > normal_temp:\n",
    "         points = points + percentile_less(patient.column('Temperature').item(0), health_table, 'Temperature') * temp_weight\n",
    "    if patient.column('O2_Scale').item(0) == 2:\n",
    "        points = points + o2scale_weight\n",
    "    if patient.column('Consciousness') == 'C':\n",
    "        points = points + conc_weight\n",
    "    elif patient.column('Consciousness') == 'U':\n",
    "        points = points + conc_weight * 3/4\n",
    "    elif patient.column('Consciousness') == 'P':\n",
    "        points = points + conc_weight * 2/4\n",
    "    elif patient.column('Consciousness') == 'V':\n",
    "        points = points + conc_weight * 1/4\n",
    "    elif patient.column('Consciousness') == 'A':\n",
    "        points = points\n",
    "    if patient.column('On_Oxygen') == 1:\n",
    "        points = points + onoxy_weight\n",
    "    return points"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fac5872e-ef40-41ae-9280-875617f08fb5",
   "metadata": {},
   "outputs": [],
   "source": [
    "#reclassification function\n",
    "\n",
    "def reclassification(points):\n",
    "    if points >= 80:\n",
    "        return \"Urgent\"\n",
    "    elif points >= 60:\n",
    "        return \"High\"\n",
    "    elif points >= 40:\n",
    "        return \"Moderate\"\n",
    "    elif points >= 20:\n",
    "        return \"Low\"\n",
    "    else:\n",
    "        return \"Normal\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "439c580a-ea4d-4a5b-8437-7b901edc664c",
   "metadata": {},
   "outputs": [],
   "source": [
    "example_patients = Table().with_columns(\n",
    "    \"Patient_ID\", make_array(\n",
    "        \"Normal_Example\",\n",
    "        \"Low_Example\",\n",
    "        \"Moderate_Example\",\n",
    "        \"High_Example\",\n",
    "        \"Urgent_Example\"\n",
    "    ),\n",
    "    \"Respiratory_Rate\", make_array(\n",
    "        15.77,  # Normal\n",
    "        19.04,  # Low\n",
    "        22.32,  # Moderate\n",
    "        27.39,  # High\n",
    "        27.76   # Urgent\n",
    "    ),\n",
    "    \"Oxygen_Saturation\", make_array(\n",
    "        97.14,\n",
    "        94.56,\n",
    "        92.53,\n",
    "        87.54,\n",
    "        86.20\n",
    "    ),\n",
    "    \"O2_Scale\", make_array(\n",
    "        1, 1, 1, 1, 2\n",
    "    ),\n",
    "    \"Systolic_BP\", make_array(\n",
    "        126.74,\n",
    "        114.41,\n",
    "        101.92,\n",
    "        88.27,\n",
    "        80.74\n",
    "    ),\n",
    "    \"Heart_Rate\", make_array(\n",
    "        75.6,\n",
    "        90.22,\n",
    "        102.54,\n",
    "        118.74,\n",
    "        122.28\n",
    "    ),\n",
    "    \"Temperature\", make_array(\n",
    "        36.84,\n",
    "        37.41,\n",
    "        38.31,\n",
    "        38.80,\n",
    "        39.06\n",
    "    ),\n",
    "    \"Consciousness\", make_array(\n",
    "        \"A\", \"A\", \"A\", \"A\", \"C\"\n",
    "    ),\n",
    "    \"On_Oxygen\", make_array(\n",
    "        0, 0, 0, 0, 1\n",
    "    )\n",
    ")\n",
    "\n",
    "example_patients"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3c2c1a4d-7973-4466-ab4a-0dc925515a24",
   "metadata": {},
   "outputs": [],
   "source": [
    "example_point_table = example_patients.with_column('Points', example_patients.apply(points, 'Patient_ID'))\n",
    "example_point_table"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f73c7994-dc47-4e7e-b95c-758eec780530",
   "metadata": {},
   "outputs": [],
   "source": [
    "reclassified_example = example_patients.with_column('Classification', example_point_table.apply(reclassification, 'Points'))\n",
    "reclassified_example"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
